class Context{constructor(a="",b){this.url=a;let c;if(a.includes("://")){let[b,d]=a.split("://");this.protocol=b,c=d.substr(d.indexOf("/")),this.domain=d.substring(0,d.indexOf("/"))}else c=a;let[d,e]=c.split("?");this.path=d||"",this.routerId=b,this.collectSearchParams(e),this.isRecordedHistory=!1}collectSearchParams(a){if(this.search=a||"",!a)return;let b={};a.split("&").forEach(a=>{if(a.includes("=")){let[c,d]=a.split("=");b[c]=d}}),this.search.params=b}}class TokenizedPath{constructor(a){this.path=a,this.regExPath="*"===a[a.length-1]?new RegExp("^"+a.substr(0,a.length-1).replace(/\:[^\/]*/,".*")+".*$"):new RegExp("^"+a+"$"),this.sections="/"===a[0]?a.slice(1).split("/"):a.split("/"),this.tokens=this.sections.map(a=>{if(TokenizedPath.MATCHING_PARAM.test(a)){let[b,c]=a.slice(1).split("(");return c=new RegExp("^("+c+"$"),{name:b,regex:c}}if(TokenizedPath.SIMPLE_PARAM.test(a)){let b=a.slice(1),c=/.+/;return{name:b,regex:c}}return{regex:new RegExp("^"+a+"$")}})}matches(a){let b=this.regExPath.test(a),c=a;"/"===a[a.length-1]&&(c=a.substring(0,a.length-1));let d=c.slice(1).split("/");if(!b&&d.length!==this.sections.length)return!1;let e={};for(let c=0;c<d.length;c++){let a=this.tokens[c],f=d[c];if(a&&a.regex.test(f))a.name&&(e[a.name]=f);else if(!b)return!1}return e}static get SIMPLE_PARAM(){return /^:\w+$/}static get MATCHING_PARAM(){return /^:\w+\(.*\)$/}}class DerivedSubpath{constructor(a,b){this.name=a,this.callback=b}}class RouteHandler{constructor(a,b){this.isRegex=a instanceof RegExp,this.isRegex?this.regex=a:(this.path=a,this.tokenizedPath=new TokenizedPath(a.replace(/\$:/g,":"))),this.actions=b}matches(a){if(this.isRegex)return this.regex.test(a.path)?(a.params={},[a=>this.fireActions(a),a]):[];else{let b=a.path.replace(new RegExp(`^${a.basePath}`),""),c=this.tokenizedPath.matches(b);return!1===c?[]:(a.params=c,[a=>this.fireActions(a),a])}}fireActions(a){let b=0,c=()=>{let d=this.actions[b++];d&&d(a,c)};c()}}class Router{constructor(a){a=a||{},this.routerId=a.routerId||Math.random(),this.debug=!!a.debug,this.registrar=[],this.globalActions=[],this.subPaths={},this.basePath=a.basePath&&"/"!==a.basePath?a.basePath||"":"",a.registerOn&&this.registerOn(a.registerOn),this.debug&&this.globalActions.push((a,b)=>{console.log(a),b()})}use(a,...b){return a instanceof DerivedSubpath?this.subPaths[a.name]=a.callback:a instanceof RouteHandler?this._registerHandlers(a):a instanceof Function?this.globalActions=[...this.globalActions,a,...b]:a instanceof Array?a.forEach(a=>{this.use(a,...b)}):"string"==typeof a||a instanceof RegExp?this._registerHandlers(new RouteHandler(a,b)):console.error(`Router::use - first argument of type not supported:`,a),this}_registerHandlers(a,b=!1){if(a.isRegex)return void this.registrar.push(a);let c=a.path;if(c.includes("?")){let b=[],d=[];return c.split("/").forEach(a=>{"?"===a[a.length-1]?b.push(a.substring(0,a.length-1)):(b.push(a),d.push(a))}),this._registerHandlers(new RouteHandler(d.join("/"),a.actions)),void this._registerHandlers(new RouteHandler(b.join("/"),a.actions))}if(c.includes("$:")){let a=c.indexOf("$:"),b=c.substring(0,a-1),d=c.substr(a+2),e=d.split("/")[0].split("(")[0];this.registrar.push(new RouteHandler(b,[async a=>{try{let b=a.path.length-1,c=a.search?"?"+a.search:"",d="/"===a.path[b]?a.path.substring(0,b):a.path,f=`${d}/${await this.subPaths[e](a)}${c}`;this.redirect(f)}catch(a){throw a}}]));let f=c.replace("$:",":");f.includes("$:")&&this._registerHandlers(new RouteHandler(f),!0);let g=d.split("/").slice(1),h=[b,...g].join("/");this.registrar.push(new RouteHandler(h,[async a=>{try{let c=a.search?"?"+a.search:"",d=await this.subPaths[e](a),f=await Promise.all(g.map(b=>{let c=b.match(/[$]?:/);if(c){let d=b.replace(c[0],"").split("(")[0];return c[0].startsWith("$")?this.subPaths[d](a):a.params[d]||b}return b})),h=`${[b,d,...f].join("/")}${c}`;this.redirect(h)}catch(a){throw a}}]))}b||this.registrar.push(a)}registerOn(a){if(!a.attachedRouter){this.domain=new Context(a.location.href).domain;let b=a.document.ontouchstart?"touchstart":"click";this._onClick=this._onClick.bind(this),this._onPopState=this._onPopState.bind(this),a.addEventListener(b,this._onClick),a.addEventListener("popstate",this._onPopState),a.attachedRouter=this,this.window=a,this.debug&&console.log(`Router {${this.routerId}} registered to`,a,this)}else throw new Error(`ClilentRouter::registerOn(): a router is already attached: Router {#${a.attachedRouter.routerId}}`);return this}unregister(){let a=window.document.ontouchstart?"touchstart":"click";return window.removeEventListener(a,this._onClick),window.removeEventListener("popstate",this._onPopState),this.window.attachedRouter=null,delete this.window.attachedRouter,this}_onClick(a){if(a.metaKey||a.ctrlKey||a.shiftKey)return;if(a.defaultPrevented)return;let b=a.target,c=a.path||a.composedPath();if(c)for(let a=0;a<c.length;a++)if(c[a].href&&"A"===c[a].nodeName){b=c[a];break}let d=b.href;d&&(a.preventDefault(),this.evaluate(new Context(d,this.routerId)))}_onPopState(a){a.state&&a.state.routerId===this.routerId&&this.evaluate(a.state)}evaluate(a,b){if(a.domain&&this.domain===a.domain||!a.domain){a.basePath=this.basePath;for(let c=0;c<this.registrar.length;c++){let[d,e]=this.registrar[c].matches(a);if(d)return this.debug&&(console.group(`Router {${this.routerId}}::[route match]: ${e.path}`),1<this.globalActions.length&&console.log("Global Middleware:",this.globalActions),console.log(this.registrar[c])),this._fireGlobalActions(e),d(e),this._pushState(e,b),void(this.debug&&console.groupEnd(`Router {${this.routerId}}::[route match]: ${e.path}`))}}this.window.location=a.url}_pushState(a,b=!1){a.isRecordedHistory||(a.isRecordedHistory=!0,b?this.window.history.replaceState(a,null,a.path):this.window.history.pushState(a,null,a.path))}_fireGlobalActions(a){let b=0,c=()=>{let d=this.globalActions[b++];d&&d(a,c)};c()}redirect(a){return this.evaluate(new Context(a,this.routerId),!0),this}navigate(a){return this.evaluate(new Context(a,this.routerId)),this}back(){return this.window.history.back(),this}forward(){return this.window.history.forward(),this}start(){return this.window||(this.window=window),this.evaluate(new Context(this.window.location.href,this.routerId)),this}}"object"==typeof module&&module.exports?module.exports={Router,Context,DerivedSubpath,RouteHandler,TokenizedPath}:Object.assign(window,{Router,Context,DerivedSubpath,RouteHandler,TokenizedPath});