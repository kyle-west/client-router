class Context{constructor(a="",b){this.url=a;let c;if(a.includes("://")){let[b,d]=a.split("://");this.protocol=b,c=d.substr(d.indexOf("/")),this.domain=d.substring(0,d.indexOf("/"))}else c=a;let[d,e]=c.split("?");this.path=d||"",this.routerId=b,this.collectSearchParams(e),this.isRecordedHistory=!1}collectSearchParams(a){if(this.search=a||"",!a)return;let b={};a.split("&").forEach(a=>{if(a.includes("=")){let[c,d]=a.split("=");b[c]=d}}),this.search.params=b}}class TokenizedPath{constructor(a){this.path=a,this.regExPath="*"===a[a.length-1]?new RegExp("^"+a.substr(0,a.length-1).replace(/\:[^\/]*/,".*")+".*$"):new RegExp("^"+a+"$"),this.sections="/"===a[0]?a.slice(1).split("/"):a.split("/"),this.tokens=this.sections.map(a=>{if(TokenizedPath.MATCHING_PARAM.test(a)){let[b,c]=a.slice(1).split("(");return c=new RegExp("^("+c+"$"),{name:b,regex:c}}if(TokenizedPath.SIMPLE_PARAM.test(a)){let b=a.slice(1),c=/.+/;return{name:b,regex:c}}return{regex:new RegExp("^"+a+"$")}})}matches(a){let b=this.regExPath.test(a),c=a;"/"===a[a.length-1]&&(c=a.substring(0,a.length-1));let d=c.slice(1).split("/");if(!b&&d.length!==this.sections.length)return!1;let e={};for(let c=0;c<d.length;c++){let a=this.tokens[c],f=d[c];if(a&&a.regex.test(f))a.name&&(e[a.name]=f);else if(!b)return!1}return e}static get SIMPLE_PARAM(){return /^:\w+$/}static get MATCHING_PARAM(){return /^:\w+\(.*\)$/}}class DerivedSubpath{constructor(a,b){this.name=a,this.callback=b}}class RouteHandler{constructor(a,b){this.path=a,this.tokenizedPath=new TokenizedPath(a.replace(/\$:/g,":")),this.actions=b}matches(a){let b=this.tokenizedPath.matches(a.path);return!1!==b&&(a.params=b,this.fireActions(a),!0)}fireActions(a){let b=0,c=()=>{let d=this.actions[b++];d&&d(a,c)};c()}}class ClientRouter{constructor(a){a=a||{},this.routerId=a.routerId||Math.random(),this.debug=!!a.debug,this.registrar=[],this.subpaths={}}use(a,...b){a instanceof DerivedSubpath?this.subpaths[a.name]=a.callback:a instanceof RouteHandler?this.registerHandlers(a):a instanceof Array?a.forEach(a=>{this.use(a,...b)}):"string"==typeof a&&this.registerHandlers(new RouteHandler(a,b))}registerHandlers(a,b=!1){let c=a.path;if(c.includes("?")){let b=[],d=[];return c.split("/").forEach(a=>{"?"===a[a.length-1]?b.push(a.substring(0,a.length-1)):(b.push(a),d.push(a))}),this.registerHandlers(new RouteHandler(d.join("/"),a.actions)),void this.registerHandlers(new RouteHandler(b.join("/"),a.actions))}if(c.includes("$:")){let a=c.indexOf("$:"),b=c.substring(0,a-1),d=c.substr(a+2),e=d.split("/")[0].split("(")[0];this.registrar.push(new RouteHandler(b,[async a=>{try{let b=a.path.length-1,c=a.search?"?"+a.search:"",d="/"===a.path[b]?a.path.substring(0,b):a.path,f=`${d}/${await this.subpaths[e](a)}${c}`;this.redirect(f)}catch(a){throw a}}]));let f=c.replace("$:",":");f.includes("$:")&&this.registerHandlers(new RouteHandler(f),!0)}b||this.registrar.push(a)}registerOn(a){if(!a.attachedClientRouter){this.domain=new Context(a.location.href).domain;let b=a.document.ontouchstart?"touchstart":"click";a.addEventListener(b,this._onClick.bind(this)),a.addEventListener("popstate",this._onPopState.bind(this)),a.attachedClientRouter=this,this.window=a,this.debug&&console.log(`Router {${this.routerId}} registered to`,a,this)}else throw new Error(`ClilentRouter::registerOn(): a router is already attached: ClientRouter {#${a.attachedClientRouter.routerId}}`)}_onClick(a){if(a.metaKey||a.ctrlKey||a.shiftKey)return;if(a.defaultPrevented)return;let b=a.target,c=a.path||a.composedPath();if(c)for(let a=0;a<c.length;a++)if(c[a].href&&"A"===c[a].nodeName){b=c[a];break}let d=b.href;d&&(a.preventDefault(),this.evaluate(new Context(d,this.routerId)))}_onPopState(a){a.state&&a.state.routerId===this.routerId&&this.evaluate(a.state)}evaluate(a,b){if(a.domain&&this.domain===a.domain||!a.domain)for(let c=0;c<this.registrar.length;c++)if(this.registrar[c].matches(a))return void this.pushState(a,b);this.window.location=a.url}pushState(a,b=!1){a.isRecordedHistory||(a.isRecordedHistory=!0,b?this.window.history.replaceState(a,null,a.path):this.window.history.pushState(a,null,a.path))}redirect(a){this.evaluate(new Context(a,this.routerId),!0)}navigate(a){this.evaluate(new Context(a,this.routerId))}back(){this.window.history.back()}forward(){this.window.history.forward()}}"object"==typeof module&&module.exports?module.exports={ClientRouter,Context,DerivedSubpath,RouteHandler,TokenizedPath}:Object.assign(window,{ClientRouter,Context,DerivedSubpath,RouteHandler,TokenizedPath});